<!DOCTYPE html>
<html>
	<head>
		<meta charset='utf-8' />
		<title>Youtube API test</title>
	</head>

	<body id="my-container">
		<!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
		<div class="vid-container">
			<div id="player"></div>
		</div>

		<div id="my_bar">
			<p>Volume </p>
			<div id="bar-container">
				<div id="bar"></div>
			</div>
		</div>

		<script src="https://www.youtube.com/iframe_api"></script>

		<script>
		</script>

		<style>
		body {
			width: 100%;
		}

		/* process bar */
		#my_bar {
			margin-right: 0;
			display: flex;
				flex-direction: column;
			align-items: center;
		}

		#my_bar > p {
			font-weight: bold;
		}

		#bar-container {
			display: block;
			width: 15px;
			height: 300px;
			background-color: #00c6ed;
			border: solid 3px #008da8
		}

		#bar {
			width: 15px;
			height: 0%;
			background-color: white;
		}

		.vid-container {
			display: block;
			width: 80%;
			float:left;
		}
		</style>
	</body>
	<script>
		// 3. This function creates an <iframe> (and YouTube player)
		//    after the API code downloads.
		let player = null, elem, volElem, vid_id = '_oikTts7L7g';
		let w = Math.round(window.innerWidth * 0.85);
		let h = Math.round(w * 370/610)

		let isFullScreen = false;
		let delayCount = (new Date()).getTime();
		function onYouTubeIframeAPIReady() {
			player = new YT.Player('player', {
				height: h.toString(),
				width: w.toString(),
				videoId: vid_id,
				playerVars: {
					'playsinline': 1
				},
				events: {
					'onReady': onPlayerReady,
					// 'onStateChange': onPlayerStateChange
				}
			});
		}

		// 4. The API will call this function when the video player is ready.
		function onPlayerReady(event) {
			// event.target.playVideo();
			elem = document.getElementById('player')
			elem.style.width = w;
			volContainer = document.getElementById('bar-container')
			volContainer.style.height = Math.floor(h * 0.9);
			volElem = document.getElementById('bar')
			volElem.style.height = (100 - player.getVolume()) + '%';
		}

		function playVideo() {
			console.log("Playing")
			if (player.getPlayerState() != 1) {
				player.playVideo()
			}
		}

		function pauseVideo() {
			player.pauseVideo();
		}

		function resetVideo() {
			player.seekTo(0, true)
		}

		function forward(number) {
			let current = player.getCurrentTime()
			player.seekTo(current + number, true)
		}

		function forward5s() {
			forward(5)
		}

		function forward10s() {
			forward(10)
		}

		function backward10s() {
			forward(-10);
		}

		// volume
		function adjustVol(number) {
			let current = player.getVolume();
			let vol = current + number;
			if (vol < 0 || vol > 100)
				return
			player.setVolume(vol)
			volElem.style.height = (100 - vol) + '%';
		}

		function increaseVol() {
			adjustVol(10)
		}

		function decreaseVol() {
			adjustVol(-10)
		}

		/* View in fullscreen */
		function openFullscreen() {
			if (elem.requestFullscreen) {
				elem.requestFullscreen();
			} else if (elem.webkitRequestFullscreen) { /* Safari */
				elem.webkitRequestFullscreen();
			} else if (elem.msRequestFullscreen) { /* IE11 */
				elem.msRequestFullscreen();
			}
		}

		/* Close fullscreen */
		function closeFullscreen() {
		  if (document.exitFullscreen) {
			document.exitFullscreen();
		  } else if (document.webkitExitFullscreen) { /* Safari */
			document.webkitExitFullscreen();
		  } else if (document.msExitFullscreen) { /* IE11 */
			document.msExitFullscreen();
		  }
		}

		window.parent.postMessage(
			{
				isStreamlitMessage: true,
				type: "streamlit:componentReady",
				apiVersion: 1,
			},
			"*"
		)

		window.parent.postMessage(
			{
				isStreamlitMessage: true,
				type: "streamlit:setFrameHeight",
				height: h,
			},
			"*"
		)

		window.parent.postMessage(
			{
				isStreamlitMessage: true,
				type: "streamlit:setFrameWidth",
				width: w,
			},
			"*"
		)

		function onDataFromPython(event) {
			if (event.data.type !== "streamlit:render") return;
			let type = event.data.args.cmd_type;  // Access values sent from Python here!
			let payload = event.data.args.cmd_payload;

			if (type === "load") {
				vid_id = payload
				if (elem == null || vid_id == null)
					return

				player.cueVideoById(vid_id, 0)
			}
			else if (type === "control") {
				command = payload
				switch (command)
				{
					case "0":
						playVideo();
						break;
					case "1":
						pauseVideo();
						break;
					case "2":
						forward10s();
						break;
					case "3":
						backward10s();
						break;
					case "4":
						increaseVol();
						break;
					case "5":
						decreaseVol();
						break;
					case "6":
						let current = (new Date()).getTime();
						if (current - delayCount > 1000) {
							delayCount = current;
						}
						else {
							break
						}

						try {
							if (document.fullscreenElement === null) {
								openFullscreen();
							} else {
								closeFullscreen();
							}
						} catch(e) {
							alert("Automatic fullscreen is limited. Please manually interact with the video and try again.")
						}
						break;
					case "7":
						let ad_button = document.querySelector('.ytp-ad-skip-button');
						if (ad_button === null) {
							break
						}
						ad_button.click();
						break;
					default:
						break;
				}
			}
		}
		window.addEventListener("message", onDataFromPython);
	</script>
</html>
